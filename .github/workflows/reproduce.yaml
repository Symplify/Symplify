# builds the content of https://github.com/symplify/easy-coding-standard

# inspiration from https://github.com/phpstan/phpstan-src/blob/master/.github/workflows/phar.yml
# and from https://github.com/rectorphp/rector/blob/main/.github/workflows/build_scoped_rector.yaml

name: Reproduce

on:
    pull_request: null

env:
    # see https://github.com/composer/composer/issues/9368#issuecomment-718112361
    COMPOSER_ROOT_VERSION: "dev-main"

jobs:
    reproduce:
        runs-on: ubuntu-latest
        steps:
            -
                uses: actions/checkout@v2
                # this is required for "WyriHaximus/github-action-get-previous-tag" workflow
                # see https://github.com/actions/checkout#fetch-all-history-for-all-tags-and-branches
                with:
                    fetch-depth: 0

            -
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 8.0
                    coverage: none

            -   run: composer update --no-progress --ansi

            # 1. install package dependencies
            -   run: packages/monorepo-builder/bin/monorepo-builder localize-composer-paths packages/easy-coding-standard/composer.json --ansi

            -
                run: composer install --working-dir packages/easy-coding-standard --ansi --no-dev

            # 2. prepare build directory
            -   run: cp -r packages/easy-coding-standard/. ecs-build
            # remove test files
            -   run: rm -rf ecs-build/tests ecs-build/packages/changed-files-detector/tests ecs-build/packages/configuration/tests ecs-build/packages/fixer-runner/tests ecs-build/packages/sniff-runner/tests ecs-build/packages/snippet-formatter/tests

            # 3. downgrade
            -   run: sh packages/easy-coding-standard/build/downgrade-ecs.sh ecs-build

            # 4. prefix
            -   run: sh packages/easy-coding-standard/build/build-ecs-scoped.sh ecs-build ecs-prefixed-downgraded

            -   run: chmod 777 ./ecs-prefixed-downgraded/bin/ecs

            # copy github actoins to repository, so tests run there too
            -   run: cp -R packages/easy-coding-standard/build/target-repository/. ecs-prefixed-downgraded

            # downgrade the bootstrap.php file too
            -   run: php vendor/bin/rector process ecs-prefixed-downgraded/bootstrap.php --config packages/easy-coding-standard/build/config/config-downgrade.php --ansi
            -
                uses: shivammathur/setup-php@v2
                with:
                    php-version: 7.1
                    coverage: none

            -   run: cd ecs-prefixed-downgraded && bin/ecs check ../ecs.php --config=../ecs.php
